---
title: "Diferencia en diferencias"
author: "Irvin Rojas"
format: 
  revealjs:
    slide-number: c/t
    width: 1600
    height: 900
---


```{r setup}
#| echo: false
#| warning: false 
#| message: false
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(tidyverse)
library(knitr)
library(stargazer)
library(janitor)
library(sandwich)
library(nnet)
library(marginaleffects)
library(foreign)
library(AER)
library(ggbrace)
```



# Diferencia en diferencias 

- La estrategia de diferencia en diferencias especifica las condiciones bajo las cuales es posible identificar el efecto del tratamiento al comparar unidades tratadas y no tratadas, cuando se dispone de información antes y después de la intervención

- Esta estrategia es ampliamente utilizada para analizar el efecto de leyes y políticas que afectan a un grupo de individuos al mismo tiempo

- Además, constituye el fundamento para otro de los métodos en donde la investigación actual es muy activa, el control sintético


## Introducción


:::: {.columns}

::: {.column width="50%"}
- Angrist & Pischke (2014) describen lo sucedido con el sector bancario en Mississippi durante la Gran Depresión

- En EUA, la FED tiene 12 bancos regionales y cada uno tiene autonomía para tomar ciertas decisiones de política monetaria

- En particular, Mississippi tiene una parte del estado bajo el mando del distrito 6 (Atlanta) y la otra mitad en el distrito 8 (San Luis)
:::

::: {.column width="50%"}
```{r}
#| echo: false
knitr::include_graphics("banks_map.png")
```
:::

::::



## Diferencia en diferencias


- Como respuesta a las corridas bancarias que caracterizaron la crisis de 1929, los bancos comerciales en Mississippi se vieron expuestos a dos políticas distintas

$$
T=
\begin{cases}
1\quad\quad \text{proveer liquidez adicional (distrito 6)} \\
0\quad\quad \text{dar igual o menos liquidez (distrito 8)} \\
\end{cases}
$$


- Si estamos interesados en la cantidad de bancos que sobrevivieron y decir algo sobre qué política es más efectiva, ¿qué podemos hacer?

- Una primera respuesta sería contar la diferencia después de la crisis:

| Distrito 8 | Distrito 6 | Diferencia |
|:---:|:---:|:---:|
| $T=0$ | $T=1$ | |
| 132 bancos | 121 bancos | 11 bancos


- Pareciera que la política de proveer liquidez, *easy money*, **causó** que quebraran más bancos

- Sin embargo, esta comparación claramente ignora las condiciones iniciales



## Representación gráfica

- Gráficamente observamos

```{r}
#| output-location: column
#| code-line-numbers: "40"

banks<-read_csv("banks_mm.csv",
                       locale = locale(encoding = "latin1"))
banks <- banks %>%
  filter(month(date) == 7L,
         mday(date) == 1L) %>%
  mutate(year = year(date)) %>%
  select(year,
         matches("bi[ob][68]")) %>% 
  select(year,bib6,bib8) %>% 
  gather(distrito,banks,bib6:bib8) %>% 
  mutate(treatment=ifelse(distrito=="bib6",1,0)) %>% 
  mutate(post=ifelse(year>=1931,1,0))

banks %>% 
  mutate(banks=ifelse(year==1930 | year==1931,banks,NA)) %>% 
  filter(year <= 1932) %>% 
  ggplot(aes(x=year, y=banks, color=distrito)) +
  geom_line(size=2) +
  scale_y_continuous(limits=c(100,180))
```
## Representación gráfica

- Del distrito 8 (no tratado) podemos obtener la pendiente:

$$m_{NT}=\frac{Y_{8,post}-Y_{8,pre}}{X_{8,post}-X_{8,pre}}=\frac{132-165}{1931-1930}=-33$$

- Y entonces, podemos encontrar cuál hubiera sido el número de bancos en el distrio 6 (tratado) si hubiera seguido la pendiente del distrito 8:

$$m_T=\frac{\tilde{Y}_{6,post}-Y_{6,pre}}{X_{6,post}-X_{6,pre}}=\frac{\tilde{Y}_{6,post}-135}{1931-1930}=-33$$
- Por tanto, $\tilde{Y}_{6,post}=102$ es el número de bancos que el distrito 6 hubiera tenido si hubiera seguido una tendencia paralela a la del distrito 8



## Representación gráfica

- Podemos contruir el contrafactual para el distrito 6 observando la pendiente del distrito 8

```{r}
#| output-location: column

banks_contrafactual <- banks %>%
    mutate(banks=ifelse(year==1930 | year==1931,banks,NA)) %>% 
  filter(year <= 1932) %>% 
  mutate(tipo="observado")
  
d6_contrafactual <- banks_contrafactual %>% 
  filter(distrito=="bib6") %>% 
  mutate(banks=ifelse(year==1931,102,banks),
         tipo="contrafactual")

banks_contrafactual <- rbind(banks_contrafactual,d6_contrafactual)

dd_grafica <- banks_contrafactual %>% 
  ggplot(aes(x=year, y=banks, color=distrito, linetype=tipo))+
  geom_line(size=2) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_y_continuous(limits=c(100,180)) 


dd_grafica
```




## Diferencia en diferencias

- Podemos dar así una primera definición de lo que es la diferencia en diferencias del número de bancos que sobrevivieron a la Gran Depresión en Mississippi

$$
\begin{aligned}
\delta_{DID}&=(Y_{6,post}-Y_{6,pre})-(Y_{8,post}-Y_{8,pre}) \\
&=(Y_{6,1931}-Y_{6,1930})-(Y_{8,1931}-Y_{8,1930}) \\
&=(121-135)-(132-165) \\
&=-14+33 = 19
\end{aligned}
$$

- El estimador de DID toma en cuenta las diferencias inciales

- En este caso, el distrito 8 ya tenía más bancos abiertos que el 6 antes de la crisis

- DID construye un contrafactual para las unidades tratadas usando la pendiente de las unidades no tratadas


## Diferencia en diferencias

- El supuesto fundamental es el de **tendencias comunes**, es decir, que en ausencia del tratamiento, el grupo de tratamiento se hubiera comportado igual al grupo de control

- Si hay varios puntos pre intervención, el supuesto de tendencias comunes puede probarse empíricamente



## Regresión en DID

- El método puede generalizarse a más periodos de tiempo 

- Aquí, una regresión nos permite identificar el efecto del tratamiento

- Tenemos datos sobre el número de bancos en cada distrito en cada año (1929-1934)

$$y_{dt}=\alpha+\beta T_d+\gamma POST_t + \delta_{r,DID}(T_d\times POST_t)+e_{dt}$$
- $T_d$ es una dummy para los distritos tratados (distrito 6 en este caso)
  
  - Les llamamos **efectos fijos individuales** y sirven para controlar diferencias entre distritos que no cambian en el tiempo
  
- $POST_t$ es una dummy para los periodos post tratamiento (1931 en adelante)

- Al término $T_d\times POST_t$ se le conoce como el **término de interacción**, que es una dummy igual a 1 para los distritos tratados en los años post intervención

- $\delta_{r,DID}$ es el estimador de DID del efecto del tratamiento



## Regresión en DID


- Usemos los datos del archivo [banks_mm.csv](banks_mm.csv) que se utilizan en el libro

- Es una forma muy básica de datos en panel: cada fila representa un distrito en un periodo de tiempo

- Podemos identificar si cada fila pertenece a un distrito tratado o no o a un periodo posterior a al tratamiento o no

```{r}
banks
```



## Regresión en DID

- Estimemos la regresión que acabamos de motivar usando todos los periodos en el panel

```{r}
did_bank <- lm(banks ~ treatment + post+ treatment*post,
               data=banks)

summary(did_bank)
```



## Regresión en DID

- Noten que si solo usamos dos años, obtenemos exactamente lo que obtendríamos haciendo las diferencias *a mano*

$$\delta_{DiD}=(Y_{6,1931}-Y_{6,1930})-(Y_{8,1931}-Y_{8,1930})=19$$

```{r}
did_bank2 <- lm(banks ~ treatment + post+ treatment*post,
               data=filter(banks,year==1930 | year==1931))


summary(did_bank2)
```





## Violación a los supuestos

- Consideremos cosas que podrían salir mal con respecto al supuesto de tendencias paralelas

- Supongamos que un tratamiento ocurre en el periodo marcado con la línea vertical, por ejemplo, un cambio en una legislación

- En este ejemplo  algo sucedió en Allatsea que produjo un cambio en la trayectoria de mortalidad antes del cambio en la legislación

- El supuesto de tendencias paralelas sí se sostenía hasta antes de este cambio

- Sin embargo, nuestra estrategia de DID atribuiría el efecto al cambio en la legislación cuando en realidad cuando ese cambio ocurrió ya nole pasó nada a Allatsea

```{r}
#| echo: false
knitr::include_graphics("trends_1.png")
```





## Violación a los supuestos


- En este segundo ejemplo, el supuesto de tendencias paralelas pre intervención se viola

- Aunque en el momento del cambio de la política, la línea de Allatsea es más inclinada, estimar esta relación por DID de nuevo atribuiría a la política diferencias que ya existían antes de la intervención

```{r}
#| echo: false
knitr::include_graphics("trends_2.png")
```




## Violación a los supuestos

- En este tercer ejemplo hay tendencias que no son paralelas pre intervención

- Sin embargo, después de la intervención, la trayectoria de Allatsea tiene una pendiente claramente más inclinada que antes de la intervención

```{r}
#| echo: false
knitr::include_graphics("trends_3.png")
```





# Adopción escalonada

## Adopción escalonada en la *antiguedad*

- DID es uno de esos campos tan activos en la investigación que cosas que pensábamos superadas o completamente estudiadas se han modificado en los últimos años

- En esta sección mostramos el tratamiento que MHE y MM dan a los problemas de adopción escalonada

- La adopción escalonada ocurre cuando existen varios periodos de tratamiento y algunas unidades van siendo tratadas de forma desfasada

- Por ejemplo, en Méxio las leyes de despenalización del aborto o las que reconocen las uniones entre personas del mismo sexo son buenos ejemplos de tratamientos con adopción escalonada

- Hasta los trabajos de Goodman-Bacon (2021) y Chaisemartin & D’Haultfœuille (2020), los problemas con adopción escalonada se abordaban econométricamente de la misma forma que hemos descrito hasta ahora, conocida como efectos fijos en bidireccionales (sí, suena horrible dicha traducción) o *two-way fixed effects*

- Esta sección presenta el tipo de tratamiento que hoy ya consideramos inapropiado

- Más adelante se presentan alternativas para los problemas de adopción escalonada


## Edad legal para beber en EUA

- Diferencias en la edad legal para beber en Estados Unidos

- ¿Las restricciones a la edad mínima para comprar alcohol tienen un impacto en la mortalidad?

- Alabama redujo la edad legal a 19 en 1975, mientras que, por ejemplo, Arkansas mantuvo la edad en 21

- Tenemos datos de mortalidad de 1970 a 1983 para personas de entre 18 y 20 años

- Lo que hemos aprendido hasta ahora nos sugiere estimar el impacto por DID comos sigue

$$y_{st}=\alpha+\beta T_s+\gamma POST_t+\delta_{DID}(T_s\times POST_t)+e_{st}$$
- $T_s$ es una dummy igual a 0 para Arkansas en todos los periodos e igual a 1 para Alabama en todos los periodos

- $POST_t$ es igual a cero para el periodo 1970-1975 e igual a 1 para el periodo 1976-1983

- $T_s\times POST_t$ es igual a 1 para las observaciones de Alabama en los años en los que la nueva política ya está en vigor



## Más de un estado

- ¿Por qué quedarnos solo con la comparación con Arkansas?

- Podemos incluir más unidades que implementen cambios en la política en distintos momentos

- En vez de $POST_t$ usamos efectos fijos por año

- Y en vez de una dummy de tratamiento, incluimos efectos fijos por unidad

- Además, en el cambio en la ley podría no ser el mismo

  - Algunos estados mueven la edad a 18, otros a 19 y otros a 20
  
  - Podemos definir $LEGAL_{st}$ como la proporción de individuos de entre 18 y 20 años autorizados para beber en el estado $s$ y en el año $t$


$$y_{st}=\alpha+\delta_{DID}LEGAL_{st}+\sum_k\beta_k STATE_{ks}+\sum_j \gamma_j YEAR_{jt}+e_{st}$$



## Estructura de datos en panel

- Los datos que acabamos de describir tienen una estructura de panel

- La variable de panel es el estado $s$ y la variable de tiempo es el año $t$

- En nuestros datos, cada estado se encuentra presente en varios años, y para cada estado y año sabemos la mortalidad y la fracción de personas de 18 a 20 años que pueden beber

- **Efectos fijos** $STATE_{ks}$: diferencias entre estados que no cambian con el tiempo

- **Efectos año** $YEAR_{jt}$: factores que afectan a todas las unidades por igual en un momento del tiempo



## Interpretación

| Muertes por 100,000 habs.: | $\hat{\delta}_{DID}$ |
|:--- | :---: |
| Todas | 10.80 |
| | (4.59)|
| Accidentes en vehículos | 7.59 |
| | (2.50) |
| Suicidio | 0.59|
| | (0.59) |
| Causas internas | 1.33 |
| | (1.59)    |


- La interpretación de los resultados es directa

- El acceso a alcohol causa un incremento de casi 11 muertes adicionales por cada 100,000 habitantes y este efecto es estadísticamente significativo

- No hay efectos donde no esperaríamos tenerlos


