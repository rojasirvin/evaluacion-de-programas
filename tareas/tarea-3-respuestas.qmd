---
title: "Respuestas a la tarea 3"
lang: es
format: html
---

```{r setup}
#| echo: false
#| warning: false 
#| message: false
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      indent = "   ")
library(tidyverse)
library(janitor)
library(rdrobust)
library(bacondecomp)
library(lfe) #linear fixed effects
library(fixest) #incluye el estimador de SA y el correspondiente gráfico de evento
library(modelsummary)
library(MatchIt)
library(lmtest)
library(sandwich)
library(clubSandwich)
library(cobalt)
library(did)
```


# Respuestas


## Pregunta 1 

Los datos en *ehec_data.csv* son datos de panel a nivel estado para los Estados Unidos de 2008 a 2019. A partir de 2014 se llevó a cabo un proceso de expansión de un programa de ayuda para subsidiar el costo de los servicios de salud de personas de bajos ingresos, *Medicaid Expansion*. La columna **yexp2** indica el año en que cada estado es tratado con la expansión del programa, **treated** es un indicador de si el estado $i$ es tratado en el año $t$, mientras que **rel_year** indica el número de años desde la expansión. Si *yexp2==Inf*, entonces el estado no ha sido tratado para 2019. Se busca estimar el efecto de la expansión del programa en el porcentaje de la población asegurada que es de bajos ingresos, sin hijos, y de entre 25 y 64 años de edad, **dins**.

a. [5 puntos] ¿Por qué decimos que esta es una aplicación de la estimación de efectos de tratamiento con adopción escalonada?

    *En esta aplicación, cada estado comienza a ser tratado en indistintos momentos del tiempo. Si hacemos un tabulado de **yexp2** notamos cuántos estados se vuelven tratados en cada año:*

```{r}
acafs <- read_csv("../files/ehec_data.csv") 

table(filter(acafs,year==2018)$yexp2)
```
    *El panel comienza en 2008. 22 estados son tratados desde 2014, 3 en 2015 y así sucesivamente. 16 estados nunca son tratados*.

a. [5 puntos] Como punto de partida, estime el efecto del tratamiento sobre **dins** usando efectos fijos por estado y año (TWFE) y empleando una librería específica para efectos fijos, como *felm*. Tome en cuenta la agrupación de los errores. Interprete sus resultados.

   *Usando felm podemos incorporar ya el nivel de agrupación de los errores:*

```{r}
twfe <- felm(dins ~ treated | stfips + year | 0 | stfips,
              data = acafs)

modelsummary(twfe,
             coef_map = c('treated'),
             stars = c('*' = .1, '**' = .05, '***'= 0.01),
             gof_map = c('nobs'),
             output = 'gt')
```

    
a. [5 puntos] Compruebe que puede obtener el mismo resultado con una regresión lineal usando el paquete *lm* e incluyendo, además de la variable de tratamiento, dummies de estado y de año. 

   *Estimamos con dummies:*
  
```{r}
m1 <- lm(dins ~ treated + factor(stfips) + factor(year),
              data = acafs)
```

   *Luego presentamos con errores clásicos y errores agrupados:*
  
```{r}
modelsummary(list(m1, m1),
             coef_map = c('treated'),
             vcov=list(NULL, clubSandwich::vcovCR(m1, type='CR1', cluster=acafs$stfips)),
             stars = c('*' = .1, '**' = .05, '***'= 0.01),
             gof_map = c('nobs'),
             output = 'gt')
```

   
a. [10 puntos] Ahora muestre que podemos obtener el coeficiente de TWFE a partir de una regresión bivariada entre el porcentaje de la población asegurada y **treated**, una vez *purgada* por efectos fijos. Para ello, primero estime una regresión de **treated** en función de los efectos fijos. Obtenga la predicción y luego defina una nueva variable igual a la diferencia entre **treated** y la predicción que acaba de obtener. Finalmente, obtenga el coeficiente de TWFE con una regresión del porcentaje de la población asegurada en función de la diferencia antes definida.

   *Corremos la primera regresión para purgar los efectos fijos:*

  
```{r}
d1 <- lm(treated ~ factor(stfips) + factor(year),
              data = acafs)
```


   *Definimos la nueva variable:*

```{r}
acafs <- acafs %>% 
  mutate(treated_hat = treated-predict(d1))

```

   *Y finalmente estimamos:*

```{r}
summary(m2 <- lm(dins ~ treated_hat,
              data = acafs))
```

   *Obtenemos el mismo coeficiente. Frisch–Waugh–Lovell tenían razón:*

  
```{r}
modelsummary(list(m2),
             coef_map = c('treated_hat'),
             stars = c('*' = .1, '**' = .05, '***'= 0.01),
             gof_map = c('nobs'),
             output = 'gt')
```



a. [10 puntos] Realice la descomposición de Goodman-Bacon (2021). Construya un gráfico donde muestre en el eje $x$ el peso otorgado a cada comparación 2x2 y en el eje $y$ el efecto estimado correspondiente a cada comparación. Interprete el gráfico obtenido.

    *Como vimos en clase:*
    
```{r}
#Goodman-Bacon decomposition
df_bacon <- bacon(dins ~ treated,
                  data = acafs,
                  id_var = "stfips",
                  time_var = "year")

coef_bacon <- sum(df_bacon$estimate * df_bacon$weight)
print(paste("Weighted sum of decomposition =", round(coef_bacon, 4)))

twfe <- feols(dins ~ treated | stfips + year,
              data = acafs,
              cluster = ~stfips)
#Gráfico
df_bacon %>% 
  ggplot(aes(x=weight,
             y=estimate,
             shape=type)) +
  geom_point() +
  geom_hline(yintercept = round(twfe$coefficients, 4))


```
    
    *Las comparaciones que más pesan en el estimador de efectos fijos son las de estados tratados con los nunca tratados, que llegan a recibir un peso de más de 0.6. La comparación con más peso tiene un efecto estimado de 0.0749, parecida al 0.07 que se obtiene con efectos fijos.*
    
    
a. [10 puntos] Implemente el estimador de Callaway & Sant’Anna (2021) para estimar los efectos del tratamiento específicos para cada cohorte, usando el paquete *did*. Utilice como grupo de comparación los estados *no tratados aún*.

```{r}
acafs <- acafs %>% 
  mutate(stfips2 = as.numeric(factor(stfips)))

atts_nyt <- att_gt(yname = "dins",
                      tname = "year",
                      idname = "stfips2",
                      gname = "yexp2",
                      data = acafs,
                      control_group = "notyettreated",
                      est_method = 'reg',
                      bstrap = TRUE,
                      biters = 1000,
                      print_details = FALSE,
                      panel = TRUE)


summary(atts_nyt)

ggdid(atts_nyt)

```
a. [10 puntos] Reporte los resultados agregados obtenidos a partir del estimador Callaway & Sant’Anna (2021), usando una agregación dinámica que muestre los efectos promedio para cada periodo antes y después del tratamiento. Grafique e interprete los resultados.

   *Graficamos:*
  
```{r}
agg.es <- aggte(atts_nyt,
                type = "dynamic")
summary(agg.es)

ggdid(agg.es)

```

a. [10 puntos] Reporte los resultados agregados obtenidos a partir del estimador Callaway & Sant’Anna (2021), usando una agregación or grupos que muestre los efectos promedio para cada cohorte del tratamiento. Grafique e interprete los resultados.

   *Graficamos:*
  
```{r}
agg.es <- aggte(atts_nyt,
                type = "group")
summary(agg.es)

ggdid(agg.es)

```

## Pregunta 2

Suponga que se convierte en asesor de un programa de educación. Se tiene la hipótesis de que el bajo aprovechamiento académico responde a las condiciones de desventaja de los alumnos más pobres. Por tanto, el programa otorga una transferencia monetaria a los estudiantes considerados pobres. Para determinar la elegibilidad del programa, la autoridad educativa diseña un cuestionario socioeconómico y crea un índice de riqueza de los hogares. Además, esta entidad establece un umbral por debajo del cual los estudiantes son considerados pobres. Todos los estudiantes considerados pobres reciben una transferencia monetaria que es depositada en la cuenta de sus padres.

a. [5 puntos] ¿Qué aspectos del programa permitirían emplear un diseño de regresión discontinua para evaluar la efectividad de este sobre el desempeño escolar y cómo mostraría su validez empíricamente?

    *En este caso podemos usar el método de regresión discontinua por las siguientes razones:*
    
    *i.	La variable de selección es continua.*
    
    *ii.	Es estatus de tratamiento es una función determinística de la posición de la variable de selección respecto al umbral.*
    
    *iii.	La probabilidad de recibir el tratamiento es discontinua en el umbral.*
    
    *iv.	Los estudiantes no pueden manipular la riqueza del hogar para posicionarse estratégicamente por encima del umbral.*


a. [10 puntos] ¿Cómo emplearía el diseño de este programa para evaluar su efectividad con un modelo de regresión discontinua nítida? Elabore una gráfica donde explique una situación en la que el programa muestra ser efectivo. Describa cómo usaría una regresión para hacer inferencia respecto a la efectividad del programa.

    *La forma gráfica de inspeccionar la presencia de una regresión consiste en graficar la variable de resultados en función de la variable de asignación. En este caso, esperaríamos que los estudiantes que están por debajo del umbral tengan una diferencia notable en términos de su desempeño académico si la transferencia se usa para mejorar insumos en el proceso educativo. No era estrictamente necesario simular un proceso para obtener una representación gráfica, pero aquí lo hice así. Quizás esto pueda ser de utilidad para futuras aplicaciones:*
    
```{r }
set.seed(1711)
  
riqueza <- runif(1000, -1, 1)
y <- 3 + 1*riqueza - 3*(riqueza>=0) + rnorm(1000, mean = 0, sd = 0.2)

data.sharp <- data.frame(y, riqueza, c = 0)


data.sharp %>% 
  ggplot() +
  geom_point(aes(x=riqueza, y=y), size=0.5, alpha=0.5) +
  geom_abline(intercept = 3, slope = 1, linetype = "dashed") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  geom_vline(xintercept = 0) +
  xlab("Índice de riqueza")+ 
  ylab("Desempeño")

```
    
    *Paramétricamente, la forma más sencilla de identificar el efecto de la discontinuidad es especificando una regresión como sigue:*
    
    $$y_i=\alpha+\tau D_i+ \beta x_i+\varepsilon_i$$
    
    *donde $x_i$ es la variable de selección y $D_i$ es una variable indicadora que toma el valor de uno cuando el índice de riqueza se encuentra por debajo del umbral. Controlar por $x_i$ captura la relación que tiene la riqueza en el desempeño académico. Se recomiendan al menos dos tipos de procedimientos más completos para comprobar la robustez de los efectos encontrados.*
    
    *El primero es incluir un polinomio lo suficientemente flexible de $x_i$:* $$y_i=\alpha+\tau D_i+ Bf(x_i)+\varepsilon_i$$

    *El segundo consiste en permitir que la pendiente sea diferente antes y después de la discontinuidad:*
    
    $$y_i=\alpha+\tau D_i +\beta_0(x_i-x_0)+\beta_1(x_i-x_0)D_i+\varepsilon_i$$
    
    *Más aún, es posible combinar estas dos posibilidades para dar lugar a modelos más flexibles. Se espera que las conclusiones sean robustas al uso de modelos extremadamente complejos.*


a. [5 puntos] ¿Qué factores podrían invalidar el uso de este método para evaluar el programa?

    *La principal preocupación es la posibilidad de manipulación de la prevalencia de la plaga para que la medición lo clasifique como receptor del programa. Podemos pensar en situaciones donde esto pudiera suceder con un individuo altamente sofisticado que pudiera manipular la presencia de la plaga de forma estratégica. Pensando que esto es costoso, el individuo estratégicamente debería seleccionar un punto justo por encima del umbral. Aunque difícil de suceder esta posibilidad podría investigarse empíricamente, por ejemplo, verificando que no haya “amontonamientos” justo por encima de la discontinuidad.*
    
    *Si existiera corrupción y muchos no elegibles recibieran la transferencia o si las familias no gastaran la transferencia en alimentos que mejoren su seguridad alimentaria el diseño también estaría comprometido.*


a. Suponga que otro de los asesores juzga como *demasiado paternalista* la transferencia y propone que, en su lugar, se otorgue un cupón válido para canjearse por bultos de un plaguicida. Asumiendo que en una encuesta posterior usted podría conocer la cantidad precisa de plaguicida aplicado, ¿cómo emplearía un diseño de regresión discontinua difusa para evaluar el efecto del uso del plaguicida sobre la seguridad alimentaria? En particular, describa:

    i. [5 puntos] ¿Cómo estimaría la forma reducida? ¿Cuál es el coeficiente relevante y cuál es su interpretación?
    
        *El problema puede ser visto entonces como un diseño de regresión discontinua difusa. La discontinuidad define la intensidad del tratamiento, en este caso dada por la cantidad de plaguicida efectivamente aplicado. La forma reducida se estima con una regresión de la variable de resultados sobre el instrumento. Al igual que cuando se estudió la interpretación del LATE, este coeficiente da la correlación entre la seguridad alimentaria y el estado del tratamiento, pero no toma en cuenta que la seguridad alimentaria también depende de la cantidad de plaguicida usado, una decisión endógena.*    
    i. [5 puntos] ¿Cómo estimaría la primera y la segunda etapa? ¿Cuáles son los coeficientes relevantes y cuál es su interpretación? 
    
        *La primera etapa consiste en estimar la relación entre la variable endógena y el instrumento. En este caso, el instrumento es una variable indicadora que toma valor de 1 si la prevalencia de la plaga rebasa el umbral. La decisión endógena es la cantidad de plaguicida empleado. Se estima por una regresión de la variable endógena en función del instrumento.*
        
        *La segunda etapa consiste en estimar el efecto sobre la seguridad alimentaria de la cantidad plaguicida que predice el instrumento. Conceptualmente es como si se corriera una regresión de la variable de seguridad alimentaria en función de los valores ajustados en la primera etapa de la cantidad de plaguicida empleado. En la práctica, nunca se estiman dos regresiones separadas, sino que se usa la definición del estimador de mínimos cuadrados en dos etapas. El coeficiente es el efecto del uso de plaguicida en la seguridad alimentaria.*
        
    i. [5 puntos] ¿Cuáles son los supuestos necesarios para estimar este modelo usando variables instrumentales?
    
        *Los supuestos econométricos para la estimación del modelo de regresión discontinua difusa son los mismos que para cualquier otro problema de variables instrumentales: 1) Exclusión: el instrumento no pertenece a la ecuación estructural; y 2) Relevancia de la primera etapa: el instrumento está correlacionado con la variable endógena.*



